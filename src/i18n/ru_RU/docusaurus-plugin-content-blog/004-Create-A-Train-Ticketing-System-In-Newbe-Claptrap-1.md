---
date: 2020-07-20
title: Создайте простую систему продажи билетов на поезд, вариант использования Newbe.Claptrap Fraм, первый шаг - бизнес-аналитика
---

Платформа Newbe.Claptrap идеально подходит для бизнес-систем с проблемами слаженности.Система продажи билетов на поезд является очень типичным вариантом использования сценария.

В этой серии есть шаг за шагом, как мы рассмотрим, как использовать платформу Newbe.Claptrap для создания простой системы продажи билетов на поезд с точки зрения бизнеса, кода, тестирования и развертывания.

<!-- more -->

## Хвастовствие сначала ударил черновик

Давайте начнем с определения бизнес-границ и требований к производительности, необходимых для этой простой системы продажи билетов на поезд.

### Бизнес-границы

Система включает в себя только оставшуюся часть управления билетами.То есть, чтобы проверить оставшиеся места, купить билеты, чтобы уменьшить место.

Информация о заказе, платежи, управление потоком, управление ветром запросов и т.д. не включены в обсуждение.

### Бизнес-варианты использования

- Запрос оставшихся билетов, чтобы иметь возможность проверить количество поездок, доступных между двумя станциями, а также количество оставшихся мест.
- Проверьте билеты, соответствующие билетам, и вы можете узнать, сколько мест осталось между станциями для данного поезда.
- Поддержка выбора места для размещения заказов, клиенты могут выбрать данный автомобиль и место, и сделать заказ на покупку билета.

### Требования к производительности

- Запрос остаточного билета и заказ на покупку билета должны потреблять в среднем не более 20 мс.Это время включает в себя только время обработки на стороне службы, т.е. передачу сети страниц, рендеринг страниц и т. д., которые не являются частью платформы, которая не заботится о ней.
- Запрос остаточного билета может иметь задержку, но не более 5 секунд.Задержка означает, что билеты могут быть запрошены, но если заказ не имеет билета, это разрешено.

## Трудный анализ

### Управление оставшимися билетами

Трудность управления билетами на поезд заключается в особенностях остальных запасов билетов.

Обычные товары электронной коммерции, с номерами SKU в качестве наименьших единиц, каждый из которых независим друг от друга и не влияет друг на друга.

Например：В настоящее время я продаю армстронг петли ускоренной пушки, родом из планеты Сайботан, 10000 красных и белых, соответственно.Таким образом, когда пользователь разместит заказ, до тех пор, пока запасы, которые контролируют красный и белый, соответственно, не перепродаются.Между ними нет никакой взаимосвязи.

Тем не менее, билеты на поезд, но разные, потому что оставшиеся билеты будут затронуты продажей билетов от конца до конца.Вот простая логическая модель, чтобы получить более подробную информацию об этой специфике.

Теперь мы предполагаем, что есть один раз, который проходит через четыре станции a, b, c, d, и в то же время мы упрощаем сценарий, предполагая, что есть только одно место в автомобиле.

Таким образом, до тех пор, пока никто не купит билеты, остаточный билет на этот автомобиль будет выглядеть следующим образом：

| От конца до конца | Оставшиеся голоса |
| ----------------- | ----------------- |
| a,b               | 1                 |
| a,c               | 1                 |
| a,d               | 1                 |
| b,c               | 1                 |
| b,d               | 1                 |
| c,d               | 1                 |

Если клиент покупает билет a,c сейчас.Так как есть только одно место, нет никаких оставшихся билетов, кроме c, d.Остаток голосов становится следующим：

| От конца до конца | Оставшиеся голоса |
| ----------------- | ----------------- |
| a,b               | 0                 |
| a,c               | 0                 |
| a,d               | 0                 |
| b,c               | 0                 |
| b,d               | 0                 |
| c,d               | 1                 |

Чтобы быть более прямой, если клиент покупает полный билет a, d, все оставшиеся билеты будут 0.Потому что пассажир всегда сидит на этом сиденье.

Это специфика билета на поезд：одно и то же место в том же поезде, количество оставшихся билетов в каждом пункте отсеи, зависит от происхождения и конца проданного билета.

Расширяя немного, легко сделать вывод, что нет никакого влияния между различными сиденьями в одном и том же автомобиле.

### Запрос остаточного билета

Как отмечалось в предыдущем разделе, из-за специфики запасов оставшихся билетов.Для одного и того же транспортного средства a, b, c, d, есть 6 возможных вариантов покупки билетов.

И мы можем легко сделать вывод, что количество выбранных видов на самом деле рассчитывается как количество комбинаций, которые выбирают 2 на n сайтах, т.е. c(n, 2).

Тогда если у вас есть автомобиль, который проходит через 34 станции, его возможной комбинацией является c(34,2) — 561.

Как эффективно реагировать на различные запросы, которые могут существовать также является проблемой, которую система должна решить.

## Логический дизайн Claptrap

Режим Actor — это шаблон проектирования, который по своейности подходит для решения проблемы сету.Платформа Newbe.Claptrap, основанная на этой философии, естественно, также способна справиться с упомянутыми выше трудностями.

### Минимальные конкурентные ресурсы

Аналогия с концепцией "конкуренции ресурсов" в многопоточном программировании, здесь автор выдвигает концепцию "наименьшего конкурентного ресурса" в бизнес-системе.Эта концепция позволяет легко найти точки проектирования о том, как применять Newbe.Claptrap.

Например, в случае, если автор продает ускорительную пушку Абстронга, каждый товар в том же цвете является "наименьшим конкурентным ресурсом".

Обратите внимание, что это не означает, что все товары в том же цвете являются "наименьшим конкурентным ресурсом".Потому что, если 10000 товаров пронумерованы, то нет никакой конкуренции, чтобы купить товары No 1 и No 2.Таким образом, каждый товар является наименьшим конкурентным ресурсом.

Таким образом, в случае билета на поезд, наименьший конкурентный ресурс：то же место в том же поезде.

Как упоминалось выше, одно и то же место на одном и том же транспортном средстве имеет конкурентные отношения при выборе другой конечной точки, остаточного билета.В частности, например, я хочу купить билеты a, c, в то время как читатели хотят купить билеты a, b.Тогда у нас есть конкурентные отношения, и у нас будет только один человек, который может успешно приобрести этот "минимальный конкурентный ресурс".

Вот несколько примеров, которые автор считает доступными：

- В бизнес-системе, которая позволяет только одноконечный вход, счет входа пользователя является наименьшим конкурентным ресурсом
- В системе конфигурации каждый элемент конфигурации является наименьшим конкурентным ресурсом
- На фондовом рынке каждый ордер на покупку или продажу является наименьшим конкурентным ресурсом

> Это собственное гипотетические слова автора, нет ссылки на другие материалы, если есть аналогичная информация или существительное может подтверждать содержание, но и надеемся, что читатели могут оставить сообщение.

### Минимальный конкурирующий ресурс с Claptrap

Ссылка на "минимальные конкурентные ресурсы" заключается в том, что при проектировании State для Claptrap различие между минимальными конкурирующими ресурсами является важной основой для проектирования системы.

Вот вывод автора, который должен：**по крайней мере больше, чем диапазон "наименьших конкурирующих ресурсов" для Claptrap.**

В сочетании с примером Abu Stelang Skapp, если все товары одного цвета предназначены в State одного и того же Claptrap (больше, чем наименьший конкурентный ресурс).Таким образом, различные пользователи покупают товары, которые влияют друг на друга, потому что модель Actor, основанная на Claptrap, выстраивается в очередь для обработки запросов.Другими словами, предполагая, что каждый товар должен обрабатывать 10 мс, то самый быстрый запрос на покупку также требует 10 000 х * 10 мс для обработки всех запросов на покупку.Но если каждый товар пронумерован, каждый товар предназначен для State для отдельного Claptrap.Тогда, поскольку они не связаны друг с друга.Чтобы продать все товары, теоретически это займет всего 10 мс.

Это：**если State Claptrap больше, чем минимальный диапазон конкурирующих ресурсов, система не будет иметь проблем с корректностью, но может быть некоторая потеря производительности.**

Кроме того, как упоминалось ранее, в случае продажи билетов на поезд, одно и то же место на том же поезде является наименьшим конкурентным ресурсом, поэтому мы можем разработать эту бизнес-сущность как State для Claptrap.Но что, если область проектирования меньше, чем это?

Например：мы разработали State Claptrap как оставшийся билет на одно и то же место на одном и том же месте в разных точках отсчета.Тогда возникает очень традиционная проблема:："Как обеспечить правильность данных в распределенной системе".Для этого, я не могу развернуть, потому что я не могу сказать, что это просто поспешительный вывод：**"Если State Claptrap меньше, чем минимальный диапазон конкурирующих ресурсов, отношения между Claptrap станет трудно справиться, есть риск".**

### Дизайн тела Claptrap

Далее, в сочетании с теорией, описанной выше.Мы бросаем дизайн напрямую.

![Train Ticketing System Design](/images/20200720-001.png)

#### Каждое место на одном и том же автомобиле было разработано как Claptrap - SeatGrain

State этого Claptrap содержит основную информацию

| Тип                                    | Имя        | описание                                                                                                                                                                                                                                         |
| -------------------------------------- | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| IList&lt;int&gt;           | Stations   | Id-список станций маршрута начинается с начальной станции и заканчивается конечной станцией.Проверка при покупке билетов в основном.                                                                                                             |
| Dictionary&lt;int, int&gt; | StationDic | Обратный словарь индекса для идентификатора станции пути.Stations — это список index-id, который является словарем соответствующего id-index для ускорения запросов.                                                                             |
| List&lt;string&gt;         | RequestIds | Ключевые свойства.Идентификатор покупки билета, который был покупкой билета в каждом интервале.Например, индекс — 0, что означает идентификатор покупки билета от станции 0 до станции 1.Если он пуст, это означает, что нет билета на подписку. |

С помощью этой структуры данных можно реализовать два бизнеса.

##### Убедитесь, что вы можете приобрести его

Переместив два идентификатора станции, вы можете узнать, принадлежит ли это SeatGrain.И запросы для всех сегментов, соответствующих конечной точке.Просто определите, является ли все сегменты в RequestIds не имеют идентификатора покупки билета.Если нет, это означает, что вы можете купить его.Если у вас уже есть идентификатор покупки билета на каком-либо сегменте, вы больше не можете приобрести его.

Например, текущая ситуация с Stations составляет 10, 11, 12, 13. В то время как RequestIds 0, 1, 0.

Ну, если вы хотите приобрести билет>10-12, это не так, так как второй интервал RequestIds уже куплен.

Однако, если вы покупаете билеты на 10->11, вы можете, потому что первый интервал RequestIds еще никто не покупает.

##### Купить

Просто соотдайте конечную точку идентификатором покупки билета на всех настройках интервала в RequestIds.

##### Модульные тестовые варианты

Вы можете просмотреть реализацию кода для этих алгоритмов по следующей ссылке：

- [Github](https://github.com/newbe36524/Newbe.Claptrap.Examples/blob/master/src/Newbe.Claptrap.Ticketing/Newbe.Claptrap.Ticketing.Actors.Tests/TicketingTest.cs)
- [Gitee](https://gitee.com/yks/Newbe.Claptrap.Examples/blob/master/src/Newbe.Claptrap.Ticketing/Newbe.Claptrap.Ticketing.Actors.Tests/TicketingTest.cs)

#### Дизайн оставшихся билетов на все места на одном и том же автомобиле, как Claptrap-TrainGran

State этого Claptrap содержит некоторую основную информацию

| Тип                                              | Имя       | описание                                                                                                                                                                                                                                |
| ------------------------------------------------ | --------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| IReadOnlyList&lt;int&gt;             | Stations  | Id-список станций маршрута начинается с начальной станции и заканчивается конечной станцией.Проверка при основном запросе.                                                                                                              |
| IDictionary&lt;StationTuple, int&gt; | SeatCount | Ключевые свойства.StationTuple представляет собой конечную точку.Коллекция содержит все возможные условия билета от конечной точки.Например, если автомобиль проходит через 34 места выше, словарь содержит 561 ключевой набор значений |

Основываясь на приведенной выше структуре данных, необходимо синхронизировать соответствующую информацию с Grain только после каждого завершения заказов SeatGrain.

Например, если a, c происходит покупка билета, вычитаете оставшиеся билеты a, c/a, b/b, c.

Это можно сделать с помощью механизма Minion, встроенного в эту платформу.

Стоит отметить, что это дизайн больше, чем "минимальный конкурентный ресурс".Поскольку сценарий запроса не требует абсолютной быстроты в этом бизнес-сценарии.Такая конструкция снижает сложность системы.

## Сделать небольшой узел

В этой статье мы используем бизнес-анализ, чтобы получить сочетание управления билетами на поезд и Newbe.Claptrap.

Мы рассмотрим разработку, тестирование и развертывание вокруг проекта этой статьи.

На самом деле, исходный код проекта уже построен, и читатели могут получить его по следующему адресу：

- [Github](https://github.com/newbe36524/Newbe.Claptrap.Examples)
- [Gitee](https://gitee.com/yks/Newbe.Claptrap.Examples)

Особая благодарность[wangjunjx8868](https://github.com/wangjunjx8868)интерфейс, созданный с использованием Blazor для этого примере.

<!-- md Footer-Newbe-Claptrap.md -->
