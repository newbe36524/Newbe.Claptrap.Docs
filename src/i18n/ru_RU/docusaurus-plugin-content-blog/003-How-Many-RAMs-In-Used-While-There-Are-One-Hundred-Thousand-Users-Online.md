---
date: 2020-06-18
title: Сколько памяти требуется 100 000 одно- и то жего онлайн-пользователей? Эксперимент по горизонтальному расширению платформы Newbe.Claptrap
---

Проект Newbe.Claptrap представляет собой платформу разработки на стороне службы, основанную на теории`-реактивных`, режимов`Actor`и`Actor Tracking`.В этой статье мы рассмотрим возможности платформы с точки зрения горизонтального масштабирования.

<!-- more -->

## Предостережения

Со временем мы встретимся снова сегодня.Начните с введения в прошлые проекты：

[Читатели, которые впервые вступают в контакт с этой структурой, могут сначала нажать здесь, чтобы прочитать основные теории и принципы работы, связанные с этой структурой.](001-Overview-Of-Newbe-Claptrap)

Недавно мы также написали несколько разогрева статей и инструментов, которые читатели могут узнать по ссылкам ниже：

- [Говоря о применении реактивного программирования на стороне службы, операции с базой данных оптимизированы от 20 до 0,5 секунды](008-Reactive-In-Server-1)
- [Newbe.Claptrap Проект Еженедельный отчет 1 - Нет тени, запустить с колесом в первую очередь](006-Newbe-Claptrap-Weekly-1)

## Тема дня

Сегодня мы сделаем экспериментальный предварительный анализ, чтобы проверить, как платформа Newbe.Claptrap может адаптироваться к растущему онлайн-пользователю с горизонтальным расширением.

## Описание бизнес-требований

Во-первых, посмотрите на бизнес-сценарии, которые будут реализованы сегодня：

- Пользователь создает JWT token после входа в систему через API
- Проверка эффективности JWT token при вызове API пользователем
- Вместо выдачи JWT token обычным открытым и закрытым ключом JWS для каждого пользователя используется secret для хэш-проверки по отдельности
- Убедитесь, что вы видите, как различные онлайн-пользователи потребляют память
- Вход пользователя в систему для создания token не должен превышать 200 мс
- Проверка tokn не должна превышать 10 мс

### Хвастовствие сначала ударил черновик

Автор не искал теоретическое определение, непосредственно связанное с "количеством пользователей в Интернете", поэтому, чтобы избежать различий в понимании.Во-первых, в соответствии с их собственным пониманием, чтобы：количество пользователей в Интернете на самом деле означает какие технические требования?

#### Пользователи, которые не находятся в Сети, не должны быть под влиянием числа пользователей, которые уже находятся в сети

Если пользователь входит в систему, он потребляет 100 мс.Таким образом, независимо от того, является ли текущее число пользователей в Интернете десять или миллион.Этот вход в интернет не может затягать более 100 мс.

Конечно, ограниченное физическое оборудование, безусловно, приведет к тому, что новые пользователи будут замедляться или даже ошибаться при входе в интернет, когда число пользователей в Интернете превышает пороговое значение (например, два миллиона).

Тем не менее, увеличение физической машины может поднять этот порог, и мы можем думать, что горизонтальное расширение дизайна является успешным.

#### Обратная связь о производительности системы должна быть одинаковой для любого пользователя, который уже находится в сети

Например, пользователи, которые уже в Сети запрашивают сведения о заказе, потребляют 100 мс.Затем среднее потребление запросов заказов, которые в настоящее время проводит любой пользователь, должно стабилизироваться на 100 мс.

Конечно, проблемы высокой концентрации производительности, такие как "snasnas", должны быть исключены здесь.Здесь в основном обсуждается ежедневное и стабильное увеличение емкости.(Мы обсудим "snasnas" позже)

В частности, это понятно.Предположим, что мы делаем облачный продукт заметок.

Таким образом, если увеличение физической машины увеличивает число пользователей, которые одновременно используют облачные продукты заметок, не жертвуя производительностью любого пользователя, мы считаем, что горизонтальное масштабирование является успешным.

В этом эксперименте, если пользователь вошел в систему, он вырастет примерно на 0,5 мс при проверке эффективности JWT.

## Вызывает связь временных рядов

![Timing diagram](/images/20200621-001.png)

Краткое описание：

1. Запросы на вход, инициированные клиентом, передаются в UserGrain слой за слоем
2. UserGrain активирует Claptrap внутренне для поддержания данных о состоянии в UserGrain.Включает имя пользователя, пароль и Secret для подписи JWT.
3. Последующие сборки JWT и проверки будут использовать данные непосредственно из UserGrain.Поскольку данные в UserGrain «кэшируются» в памяти в течение определенного периода времени.Таким образом, после JWT сборки и проверки будет очень быстро.Измеренная оценка составляет около 0,5 мс.

## Проектирование физической структуры

![Проектирование физической структуры](/images/20200618-001.png)

Как показано на рисунке выше, это физический компонент, который был протестирован：

| Имя                 | описание                                                                                                                             |
| ------------------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| WebAPI              | Предоставляет интерфейс WebAPI для внешнего вызова.Предоставляет интерфейс для входа в систему и проверки токена.                    |
| Orleans Cluster     | Основной процесс хостинга Grain.                                                                                                     |
| Orleans Gateway     | В Orleans Cluster в основном то же самое, но WebAPI может общаться только с Gateway                                                  |
| Orleans Dashboard   | В Orleans Gateway в основном то же самое, но добавляет отображение Dashboard, чтобы увидеть, что происходит во всем кластере Orleans |
| Consul              | Обнаружение и обслуживание кластера для кластера Orleans                                                                             |
| Claptrap DB         | Используется для хранения данных о событиях и состоянии платформы Newbe.Claptrap                                                     |
| Influx DB & Grafana | Используется для мониторинга данных метрик производительности, связанных с Newbe.Claptrap                                            |

Количество узлов кластера Orleans в этом эксперименте на самом деле является общей суммой Cluster + Gateway + Dashboard.Вышеупомянутое деление на самом деле является различием из-за различных функциональных настроек.

Физические узлы, которые тестируют функцию горизонтального расширения, в основном являются Orleans Cluster и Orleans Gateway.Использование памяти для следующих условий будет протестировано отдельно.

| Orleans Dashboard | Orleans Gateway | Orleans Cluster |
| ----------------- | --------------- | --------------- |
| 1                 | 0               | 0               |
| 1                 | 1               | 1               |
| 1                 | 3               | 5               |

В этом эксперименте используется тест развертывания, проведенный Windows Docker Desktop в сочетании с WSL 2.

Вышеуказанные физические структуры на самом деле разработаны в соответствии с самыми сложными ситуациями в этом эксперименте.На самом деле, если бизнес-сценарий достаточно прост, физическая структура может быть обрезана.Более подробную информацию можно найти в разделе Часто задаваемые вопросы ниже.

## Фактические тестовые данные

Ниже приведены тесты для различных размеров кластеров и количества пользователей

### 0 Gateway 0 Cluster

По умолчанию при запуске узла Dashboard можно просмотреть, что container занимает около 200 МБ памяти, как показано на следующем：

![Начальный объем памяти](/images/20200621-002.png)

30 000 запросов к WebAPI были отправлены с помощью тестовой консоли.100 запросов на пакет, отправленных партиями.

После примерно двух минут ожидания, посмотрите на память еще раз, около 9,2 ГБ, как показано на рисунке ниже：

![30 000 пользователей](/images/20200621-003.png)

Таким образом, мы просто оцениваем, что каждый онлайн-пользователь потребляет около (9,2х1024-200)/30 0000 х 0,3 МБ.

Кроме того, можно просмотреть некоторые дополнительные данные：

Использование ЦП

![Использование ЦП](/images/20200621-004.png)

Пропускная способность сети

![Пропускная способность сети](/images/20200621-005.png)

Ситуация с Orleans Dashboard.30 000 в TOTAL ACTIVATIONS в левом верхнем углу представляют количество UserGrain, присутствующих в текущей памяти, а три других являются Grain, используемыми Dashboard.

![Ситуация с Orleans Dashboard](/images/20200621-006.png)

Средняя продолжительность обработки событий, просматриваемых newbe.Claptrap в Grafana, составляет около 100-600 мс.Этот тест был в основном в памяти, с длительным времям приобретения 30s один раз, так что количество выборок не так много.Мы подробно протестируем продолжительность обработки в последующих статьях.

![Среднее время обработки](/images/20200621-007.png)

Среднее время, затраченное на сохранение событий, просматриваемых newbe.Claptrap в Grafana, составляет около 50-200 мс.Продолжительность сохранения события является основной частью обработки событий.

![30 000 пользователей](/images/20200621-009.png)

Общее число обработанных событий, просмотре Newbe.Claptrap в Grafana.Один вошел в систему 30 000 раз, так что общее число инцидентов также 30000.

![Общее число обработанных событий](/images/20200621-008.png)

### 1 Gateway 1 Cluster

Далее мы тестируем два дополнительных узла для тестирования.

Опять же, количество узлов кластера Orleans на самом деле является общей суммой Cluster + Gateway + Dashboard.Таким образом, по сравнению с последним тестом, количество узлов для этого теста составляет 3.

Тестовое использование памяти выглядит следующим образом：

| Количество пользователей | Средняя память узла | Общий объем памяти |
| ------------------------ | ------------------- | ------------------ |
| 10000                    | 1.8 GB              | 1.8\*3 = 5.4 GB  |
| 20000                    | 3.3 GB              | 3.3\*3 = 9.9 GB  |
| 30000                    | 4.9 GB              | 4.9\*3 = 14.7 GB |

Таким образом, в случае 30 000 пользователей средний пользователь потребляет около (14,7|*1024-200|*3)/30 000 х 0,48 МБ

Почему увеличилось количество узлов и увеличилось среднее потребление памяти?Автор предполагает, что узлы：, которые не были проверены, увеличиваются, и на самом деле связь между узлами должна потреблять дополнительную память, поэтому она увеличивается в среднем.

### 3 Gateway 5 Cluster

Мы снова увеличим узел.Суммарные очки 1 (dashboard) + 3 (cluster) + 5 (gateway) = 9 узлов

Тестовое использование памяти выглядит следующим образом：

| Количество пользователей | Средняя память узла | Общий объем памяти |
| ------------------------ | ------------------- | ------------------ |
| 20000                    | 1.6 GB              | 1.6\*9 = 14.4 GB |
| 30000                    | 2 GB                | 2\*9 = 18 GB     |

Таким образом, в случае 30 000 пользователей средний пользователь потребляет около (18|*1024-200|*9)/30000 — 0,55 МБ

### Сколько памяти требуется 100 000 пользователей?

Все вышеперечислиеные тесты были протестированы с 30 000 пользователей, что является особым числом.Поскольку количество пользователей продолжает увеличиваться, объем памяти превышает объем памяти тестена.(Спонсировать два 16G)

Если вы продолжите увеличивать количество пользователей, начнется использование виртуальной памяти операционной системы.Хотя он работает, он работает менее эффективно.Первоначально вход в систему может занять всего 100 мс.Пользователям, используемым в виртуальной памяти, требуется 2 с.

Таким образом, при снижении скорости проверка того, сколько памяти требуется, может иметь мало смысла.

Тем не менее, это не означает, что вы не можете продолжать входить в систему, вот 1+1+1, когда все 100 000 пользователей вошли в систему.(Есть 100 000 пользователей онлайн в то же время, добавить немного памяти, не плохо.))

![100 000 пользователей](/images/20200621-010.png)

## Инструкции по сборке исходного кода

Код для этого теста можно найти в примере базы кода в конце статьи.Для того, чтобы читатели можно было экспериментировать самостоятельно, в основном с помощью docker-compose для сборки и развертывания.

Таким образом, единственным экологическим требованием для тестера является правильная установка Docker Desktop.

Последний пример кода можно получить с любого из следующих адресов：

- <https://github.com/newbe36524/Newbe.Claptrap.Examples>
- <https://gitee.com/yks/Newbe.Claptrap.Examples>

### Быстрый запуск

Используйте консоль для `в папку src/Newbe.Claptrap.Auth/LocalCluster` .Выполните следующую команду, чтобы запустить все компоненты локально：

```
docker-compose up -d
```

В пути необходимо вытащить некоторые общедоступные образы, размещенные на Dockerhub, и убедитесь, что соответствующие ускорители настроены локально, чтобы их можно было быстро построить.[вы можете настроить этот документ](https://www.runoob.com/docker/docker-mirror-acceleration.html)

После успешного запуска`все компоненты можно просмотреть` docker ps.

```bash
PS>docker ps
CONTAINER ID        IMAGE                                                                            COMMAND                  CREATED             STATUS              PORTS                                                                                                                              NAMES
66470e5393e2        registry.cn-hangzhou.aliyuncs.com/newbe36524/newbe-claptrap-auth-webapi          "dotnet Newbe.Claptr…"   4 hours ago         Up About an hour    0.0.0.0:10080->80/tcp                                                                                                              localcluster_webapi_1
3bbaf5538ab9        registry.cn-hangzhou.aliyuncs.com/newbe36524/newbe-claptrap-auth-backendserver   "dotnet Newbe.Claptr…"   4 hours ago         Up About an hour    80/tcp, 443/tcp, 0.0.0.0:19000->9000/tcp, 0.0.0.0:32785->11111/tcp, 0.0.0.0:32784->30000/tcp                                       localcluster_dashboard_1
3f60f51e4641        registry.cn-hangzhou.aliyuncs.com/newbe36524/newbe-claptrap-auth-backendserver   "dotnet Newbe.Claptr…"   4 hours ago         Up About an hour    80/tcp, 443/tcp, 9000/tcp, 0.0.0.0:32787->11111/tcp, 0.0.0.0:32786->30000/tcp                                                      localcluster_cluster_gateway_1
7d516ada2b26        registry.cn-hangzhou.aliyuncs.com/newbe36524/newbe-claptrap-auth-backendserver   "dotnet Newbe.Claptr…"   4 hours ago         Up About an hour    80/tcp, 443/tcp, 9000/tcp, 30000/tcp, 0.0.0.0:32788->11111/tcp                                                                     localcluster_cluster_core_1
fc89fcd973f9        grafana/grafana                                                                  "/run.sh"                4 hours ago         Up 6 seconds        0.0.0.0:23000->3000/tcp                                                                                                            localcluster_grafana_1
1f10ed0eb25f        postgres                                                                         "docker-entrypoint.s…"   4 hours ago         Up About an hour    0.0.0.0:32772->5432/tcp                                                                                                            localcluster_claptrap_db_1
d5d2bec74311        adminer                                                                          "entrypoint.sh docke…"   4 hours ago         Up About an hour    0.0.0.0:58080->8080/tcp                                                                                                            localcluster_adminer_1
4c4be69f2f41        bitnami/consul                                                                   "/opt/bitnami/script…"   4 hours ago         Up About an hour    8300-8301/tcp, 8500/tcp, 8301/udp, 8600/tcp, 8600/udp                                                                              localcluster_consulnode3_1
88811d3aa0d2        influxdb                                                                         "/entrypoint.sh infl…"   4 hours ago         Up 6 seconds        0.0.0.0:29086->8086/tcp                                                                                                            localcluster_influxdb_1
d31c73b62a47        bitnami/consul                                                                   "/opt/bitnami/script…"   4 hours ago         Up About an hour    8300-8301/tcp, 8500/tcp, 8301/udp, 8600/tcp, 8600/udp                                                                              localcluster_consulnode2_1
72d4273eba2c        bitnami/consul                                                                   "/opt/bitnami/script…"   4 hours ago         Up About an hour    0.0.0.0:8300-8301->8300-8301/tcp, 0.0.0.0:8500->8500/tcp, 0.0.0.0:8301->8301/udp, 0.0.0.0:8600->8600/tcp, 0.0.0.0:8600->8600/udp   localcluster_consulnode1_1
```

После завершения запуска можно просмотреть соответствующий интерфейс по следующей ссылке

| Адрес                    | описание                                                                                     |
| ------------------------ | -------------------------------------------------------------------------------------------- |
| <http://localhost:19000> | Orleans Dashboard просматривает состояние узлов в кластере Orleans                           |
| <http://localhost:10080> | Базовый адрес веб-API, который на этот раз используется для тестирования базового адреса API |
| <http://localhost:23000> | Адрес Grafana, чтобы просмотреть метрики производительности, связанные с Newbe.Claptrap      |

### Построение исходного кода

Используйте консоль для `в папку src/Newbe.Claptrap.Auth` Auth.Выполните следующую команду, чтобы завершить сборку кода локально：

```bash
./LocalCluster/pullimage.cmd
docker-compose build
```

После завершения построения соответствующее зеркало создается локально.Затем можно предпринять первую попытку запуска приложения локально：

Используйте консоль для `в папку src/Newbe.Claptrap.Auth/LocalCluster` .Запустите связанный контейнер, выполнив следующую команду:

```bash
docker-compose up -d
```

## Часто задаваемые вопросы

### Почему в этой статье не указаны детали кода и конфигурации?

Эта статья в основном показывает читателям экспериментальную осуществимость этой схемы, в частности, как платформа Newbe.Claptrap должна быть применена для написания кода, не является основной темой этой статьи, поэтому не упоминается.

Другой момент, конечно, заключается в том, что в настоящее время платформа не имеет окончательной версии, все, вероятно, изменится, и это не имеет большого смысла в объяснении деталей кода.

Но то, что можно проиллюстрировать заранее, заключается в том, что написание：очень просто, и поскольку бизнес-требования к этому примеру очень просты, содержание кода не так много.Все это можно найти в примере репозитория.

### Хранение Token с Redis также может реализовать эти требования, зачем выбирать эту платформу?

В настоящее время, у меня нет веских оснований, чтобы убедить читателей, какой сценарий должен быть использован, здесь также просто обеспечить жизнеотворную схему, что касается того, какой план на самом деле должны быть выбраны, должны быть читатели сами рассмотреть, в конце концов, является ли инструмент в первую очередь или нужно попробовать, чтобы знать.

### Если у вас есть до 100 онлайн-пользователей, как вы можете обрезать систему?

Необходимыми компонентами являются только Orleans Dashboard, WebAPI и Claptrap Db.Все остальные компоненты не являются необходимыми.И при изменении кода Orleans Dashboard и Web API могут быть объединены.

Таким образом, минимальный размер — это процесс плюс база данных.

### Почему у Grafana нет отчета?

После первого запуска Grafana необходимо вручную создать DataSource и импортировать Dashboard.

Параметры, связанные с этим экспериментом, приведены ниже：

DataSource

- URL： http://influxdb:8086
- Database： metricsdatabase
- User： claptrap
- Password： claptrap

[Нажмите здесь, чтобы получить файл определения Dashboard](https://github.com/newbe36524/Newbe.Claptrap/blob/develop/src/Docker/Monitor/grafana/claptrap.json)

### Каковы физические конфигурации тестовых машин?

16 ГБ памяти не были выделены до начала тестирования.Ниже приведены данные о фигуре испытательной машины (океанский мусор, около 3500 юаней)：

Процессор Intel Xeon (Xeon) E5-2678 v3 — 2,50 ГГц 12 ядер 24 потока материнская плата HUANANZHI X99-AD3 GAMING (Wellsburg) видеокарта Nvidia GeForce GTX 750 Ti ( 2 ГБ / Nvidia ) памяти 32 ГБ (Samsung DDR3L 1600 МГц) 2013 производство старой памяти Основной жесткий диск Кингстон SA400S37240G (240 ГБ / SSD)

Если у вас есть лучшая физическая конфигурация, я считаю, что вы можете получить лучшие данные.

### Даже 0,3 МБ на пользователя я чувствую себя слишком высоко

Платформа все еще оптимизирована.Будущее будет лучше.

<!-- md Footer-Newbe-Claptrap.md -->
