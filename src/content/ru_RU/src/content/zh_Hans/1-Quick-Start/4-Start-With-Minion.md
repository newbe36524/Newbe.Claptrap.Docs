---
title: 'Шаг 4 - Используйте Minion для размещения заказа на продукт.'
metaTitle: 'Шаг 4 - Используйте Minion для размещения заказа на продукт.'
metaDescription: 'Шаг 4 - Используйте Minion для размещения заказа на продукт.'
---

С этой статьей, вы можете начать пытаться делать бизнес с Claptrap.

> [Версия в настоящее время рассматривается является результатом китайской упрощенной машины переводит самопроверки и вручную корректирует.Если в документе есть неправильный перевод, пожалуйста, нажмите здесь, чтобы представить свои предложения по переводу.](https://crwd.in/newbeclaptrap)

<!-- more -->

## Резюме открытия.

В этой статье я узнал, как Minion может быть использован для завершения асинхронной обработки бизнеса в существующих образцах проектов, выполняя требования "заказа товаров".

Во-первых, взгляните на случаи использования бизнеса, которые должны быть охвачены в этом article：

1. Пользователь может разместить заказ, который формирует заказ, используя все SKUs в текущей корзине.
2. Инвентаризация соответствующих СКУ будет вычтена после заказа.Если SKU не имеет запасов, заказ не удается.
3. Операция заказа успешно осуществляется только до тех пор, пока инвентаризация не будет успешно вычтена, и следующие шаги не требуют области обсуждения данного образца.Таким образом, этот пример генерирует запись заказа в базе данных после успешного размещения заказа, указывая конец создания заказа.

Хотя в центре внимания этой статьи находится использование Minion, из-за необходимости использования нового объекта OrderGrain, вам все еще нужно использовать предыдущую статью "Определение Claptrap", связанные знания.

Миньон является особым видом Claptrap, и его связь с MasterClaptrap показана в следующем：

![Миньон.](/images/20190228-002.gif)

Его основной процесс разработки похож на Claptrap, только с некоторыми ограничениями.Сравнение так же follows：

| Шаги.                                  | Клэптрап. | Миньон. |
| -------------------------------------- | --------- | ------- |
| Определите ClaptrapTypeCode.           | √.        | √.      |
| Определите состояние.                  | √.        | √.      |
| Определите интерфейс Grain.            | √.        | √.      |
| Реализация зерна.                      | √.        | √.      |
| Подпишитесь на зерно.                  | √.        | √.      |
| Определите EventCode.                  | √.        |         |
| Определите событие.                    | √.        |         |
| Обработчик событий реализации.         | √.        | √.      |
| Подпишитесь на EventHandler.           | √.        | √.      |
| Внедрение IInitial State Data Factory. | √.        | √.      |

Причина такого удаления заключается в том, что, поскольку Minion является потребителем событий claptrap, определения, связанные с событиями, не должны обрабатываться.Но остальное все равно необходимо.

> В начале этой статьи мы больше не будем перечислять конкретные места файла, где находится соответствующий код, и надеемся, что читатель сможет узнать для себя в проекте, чтобы они могли освоить его.

## Реализация OrderGrain.

Основываясь на предыдущих знаниях «Об определении Claptrap», мы внедрили OrderGrain здесь, чтобы представлять операцию заказа.Чтобы сэкономить место, мы перечислим только его ключевые части.

### Состояние заказа.

Статус заказа определяется как follows：

```cs
Systems.Collections.Generic;
Ньюб.Клэптрап;

namespace HelloClaptrap.Models.Order
s
    публичного класса Состояние заказа : IStateData

        общественный заказ boolCreated s s; set; s
        public user stringId s get; set; s
        публичный словарь<string, int> Skus sned; set; s

s.
```

1. OrderCreated указывает, был ли создан заказ, избегая создания заказа неоднократно.
2. UserId размещает заказ для идентификатора пользователя.
3. Заказы Skus содержат SkuIds и объемы заказов.

### ЗаказСоздыесыесентные.

События создания заказов определяются как follows：

```cs
Systems.Collections.Generic;
Ньюб.Клэптрап;

пространство имен HelloClaptrap.Models.Order.Events

    общественный класс Order2020: IEventData
    . .
        публичную строку UserId . . . set;
        публичный словарь<string, int> Скус

    . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . ... . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .. . .
```

### ЗакажитеГрейн.

```cs
Использование System.Threading.Задачи;
Сша, Hello Claptrap.Actors.Order.Events;
1990-х годов, HelloClaptrap.IActor;
Соединенные Штаты Ofsing HelloClaptrap.Models;
.Модели.Заказ;
.HelloClaptrap.Models.Order.Events;
.Claptrap;
Ньюбе.Клэптрап.Орлеан;
Орлеан;

Namespace HelloClaptrap.Actors.Order

    (OrderCreatedEventHandler, ClaptrapCodes.Order22)
    общественного порядка : ClaptrapBox Зерно<OrderState>, Игорю Зерну
    _grainFactory
        ... . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

        . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . IClaptrapGrainCommonService Claptrap Зерно Общие услуги,
            IGrain Фабрика GrainFactory)
            : база (claptrapGrainCommonService)

            _grainFactory зернистости;


        публичной async Task CreateOrder Agent Async (CreateOrderInput)

            y.Id;
            // исключение броска, если заказ уже создан
            если (StateData.OrderCreated)

                новый bizException ($"заказ с уже созданным идентификатором заказа: {orderId}");


            // Получить предметы из корзины
            var cartGrain _grainFactory.GetGrain<ICartGrain>(вход. Картид);
            вар пунктов - ждут cartGrain.GetItemsAsync ();

            // обновление инвентаря для
            foreach (skuId, подсчитывайте) в элементах)

                var skuGrain , _grainFactory.GetGrain<ISkuGrain>(skuId);
                ждут skuGrain.UpdateInventoryAsync (-счет);
            . .

            // Удалите все предметы из корзины
            cartGrain.Re. moveAllItemsAsync();

            // Создайте
            var evt. . . СоздатьEvent (новый OrderCreatedEvent
            userid
                вход. UserId,
                Skus - предметы
            ));
            .HandleEventAsync (evt);



```

1. OrderGrain реализует основную логику создания заказов, когда метод CreateOrderAsync завершает сбор данных корзины, расходные данные, связанные с вычетом.
2. Соответствующие поля в государстве будут обновлены после успешного исполнения OrderCreatedEvent, который больше не указан здесь.

## Сохраните данные о порядке в базу данных через Minion.

С самого начала серии мы никогда не упоминали операции, связанные с базой данных.Потому что при использовании платформы Claptrap подавляющее большинство операций заменено "Письма к событиям" и "Обновлениям состояния", поэтому вам не нужно писать собственные операции с базой данных.

Однако, поскольку Claptrap обычно предназначен для модульных объектов (один заказ, один SKU, одна корзина), невозможно получить данные для всех (все заказы, все SKUs, все тележки).На этом этапе данные состояния должны быть использованы в другой постоянной структуре (база данных, файл, кэш и т.д.) для выполнения запросов или других операций для всей ситуации.

Концепция Minion была введена в рамки Claptrap для удовлетворения этих требований.

Далее мы вводим OrderDbGrain (миньон) в образец для завершения операции по вступлению заказов OrderGrain асинхронно.

## Определите ClaptrapTypeCode.

```cs
  namespace HelloClaptrap.Models

      публичного статического класса ClaptrapCodes

          #region корзину

          публичной и конст-строки CartGrain s "cart_claptrap_newbe";
          частной строкой CartEventSuffix, ""

          """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""" """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""" Tring RemoveItemFromCart - "RemoveItem" - CartEventSuffix;
          публичная реклама const Строка Удалить AllItems FrommCart , "Remoe AllItems" , CartEventSuffix;

          #endregion

          #region Ску

          публичную рекламу и skuGrain - "sku_claptrap_newbe";
          частной конст-строки SkuEventSuffix . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
          публичной рекламы и skuInventoryUpdate , "инвентарьUpdate" , SkuEventSuffix;

          #endregion

          #region приказ

          порядке общественного порядка Зеро , "order_claptrap_newbe";
          частной строкой OrderEventSuffix . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
          общественности и общественности и порядка, "заказ" , и orderEventSuffix;

общественности и общественности и общественности строку OrderDbGrain , "db_order_claptrap_newbe";

          #endregion
      ...
  ...
```

Миньон является особым видом Claptrap, другими словами, это также своего рода Claptrap.ClaptrapTypeCode требуется для Claptrap и поэтому должен быть добавлен.

## Определите состояние.

Поскольку этот пример должен только записывать заказ в базу данных и не требует каких-либо данных в государстве, этот шаг фактически не требуется в этом образце.

## Определите интерфейс Grain.

```cs
Использование HelloClaptrap.Models;
...
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
:
и пространство имен HelloClaptrap.IActor
-
- "ClaptrapMinion(ClaptrapCodes.OrderGrain)
(NoneStateData), ClaptrapCodes.OrderDbGrain) »
- публичный интерфейс IOrderDbGrain : IClaptrapMinMin



```

1. ClaptrapMinion используется для обозначения зерна как миньон, где Код указывает на соответствующий MasterClaptrap.
2. ClaptrapState используется для обозначения типа государственных данных Claptrap.На предыдущем этапе мы уточнили, что Minion не требует StateData, поэтому вместо этого мы используем NoneStateData в качестве встроенного типа фреймворка.
3. IClaptrapMinionGrain — это интерфейс Minion, который отличается от IClaptrapGrain.Если зерно является миньоном, необходимо унаследовать интерфейс.
4. ClaptrapCodes.OrderGrain и ClaptrapCodes.OrderDbGrain две разные строки, и, надеюсь, читатель не межзвездный мастер.

> Звезда Мастер：Потому что StarCraft быстро развивающийся и имеет большой объем информации, это легко для игроков, чтобы игнорировать или недооценивать некоторые из информации, поэтому часто "игроки не видят ключевых событий, которые происходят под носом" смешные ошибки.Игроки таким образом шутят, что межзвездные игроки слепы (когда-то было настоящее противостояние между слепыми и профессиональными игроками), чем выше сегмент, тем серьезнее слепота, профессиональные межзвездные игроки слепы.

## Реализация зерна.

```cs
Использование Systems.Collections.Generic;
...
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
поют HelloClaptrap.IActor;
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
...
,
, namespace HelloClaptrap.Actors.DbGrains.Order
,
, и ClaptrapEventHandler , ClaptrapCodes . OrderCreated)
и общественный класс OrderDbGrain : ClaptrapBoxGrain<NoneStateData>, IOrderGraDbin
,
, общественный заказ  claptrapGrainCommonService)
: база (claptrapGrainCommonService)



IEnumerable<IEvent> события)
-
- foreach (вар @event в событиях)
,
и ждут Claptrap.HandleEventAsync (@event);

,
,
,  , общественные WakeAsync ()
,
, возвращение Task.CompletedTask,
,
,
.
```

1. MasterEventReceivedAsync — это метод, определенный из IClaptrapMinionGrain, который означает получение уведомлений о событиях от MasterClaptrap в режиме реального времени.Не расширяя описание здесь, следуйте шаблону выше.
2. WakeAsync — это метод, определенный из IClaptrapMinionGrain, который представляет собой активное пробуждение Minion От MasterClaptrap.Не расширяя описание здесь, следуйте шаблону выше.
3. Когда читатель просматривает исходный код, он находит, что класс определяется отдельно в сборке.Это всего лишь классификация, которую можно понять как размещение Minion и MasterClaptrap в двух разных проектах.Это на самом деле не проблема положить его вместе.

## Подпишитесь на зерно.

Здесь, поскольку мы определяем OrderDbGrain в отдельной сборке, нам необходимо дополнительно зарегистрировать сборку.Как следует,：

```cs
  Использование системы;
  с помощью Autofac;
  . Хенинг HelloClaptrap.Actors.Cart;
  .HelloClaptrap.Actors.DbGrains.Order;
  .IActor;
  s общая служба, HelloClaptrap.Repository;
  .AspNetCore.Хостинг;
  .Extensions.Hosting;
  .Extensions.Logging;
  .Claptrap;
  newbe.Claptrap.Bootstrapper;
  NLog.Web;
  Орлеан;

  namespace HelloClaptrap.BackendServer

      публичная программа программы

          публичная статическая пустота основной (строки)

              вавар, NLogBuilder.ConfigureNLog ("nlog.config"). GetCurrentClassLogger ();
              попробуй
              .
                  регистратор. Отладка ("Инит главного");
                  CreateHostBuilder (args). Сборка(). Выполнить ();

              поймать (исключение исключения)

                  //NLog: поймать ошибки установки
                  регистратора. Ошибка (исключение, "Остановленная программа из-за исключения");
                  бросок;

              наконец

                  // Убедитесь, что флеш и остановит внутренние таймеры/потоки перед приложением-выходом
                  NLog.LogManager.Shutdown ();
              . . .


          рекламе статического IHostBuilder (строка)>
              . СоздатьDefaultBuilder (args)
                  . НастраиваетеWebHostDefaults (веб->
                  <Startup>. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . UseClaptrap (
                      строители>

                          Строитель
                              . ScanClaptrapDesigns (новый)

                                  typeof (ICartGrain). Сборка,
                                  typeof (CartGrain). Сборка,
и Typeof (OrderDbGrain). Собрание
                              )
                              . КонфигурацияClaptrapDesign (x .>
                                  x. Claptrap Options. EventCenter Options. EventCenterType . . EventCenterType.Orleans Client);
                      ,
                      строитель> строитель. RegisterModule<RepositoryModule>(); )
                  . UseOrleans Claptrap ()
                  . UseOrleans (строители -> строители. UseDashboards (варианты> опции. Порт s 9000))
                  . Настройте регистрацию (регистрацию)>
                  .
                      . КлирПровидс ();
                      лесозаготовки. SetMinimumLevel (LogLevel.Trace);
                  )
                  . UseNLog ();
      ...
  ...
```

## Обработчик событий реализации.

```cs
+ using System.Threading.Tasks;
+ using HelloClaptrap.Models.Order.Events;
+ using HelloClaptrap.Repository;
+ using Newbe.Claptrap;
+ using Newtonsoft.Json;
+
+ namespace HelloClaptrap.Actors.DbGrains.Order.Events
+ {
+     public class OrderCreatedEventHandler
+         : NormalEventHandler<NoneStateData, OrderCreatedEvent>
+     {
+         private readonly IOrderRepository _orderRepository;
+
+         public OrderCreatedEventHandler(
+             IOrderRepository orderRepository)
+         {
+             _orderRepository = orderRepository;
+         }
+
+         public override async ValueTask HandleEvent(NoneStateData stateData,
+             OrderCreatedEvent eventData,
+             IEventContext eventContext)
+         {
+             var orderId = eventContext.State.Identity.Id;
+             await _orderRepository.SaveAsync(eventData.UserId, orderId, JsonConvert.SerializeObject(eventData.Skus));
+         }
+     }
+ }
```

1. IOrderRepository — это интерфейс, который работает непосредственно на уровне хранения для надстройок и удаления заказов.Интерфейс называется здесь для реализации операции хранения базы данных заказов.

## Подпишитесь на EventHandler.

На самом деле, чтобы сэкономить место, мы зарегистрировались в коде для раздела "Implement Grain".

## Внедрение IInitial State Data Factory.

Поскольку StateData не имеет специального определения, нет необходимости внедрять IInitial StateData Factory.

## Модифицировать контроллер.

В примере мы добавили OrderController для размещения заказов и заказов запросов.Читатели могут просматривать его в исходном коде.

Читатели могут использовать следующие шаги для проверки фактического：

1. POST `/api/cart/123` "skuId": "yueluo-666", "count": 30" к 123 корзине, чтобы добавить 30 единиц концентрата yueluo-666.
2. POST `/api/order` («userId»: "999", "cartId": "123") как 999 userId, из 123 корзины для размещения заказа.
3. GET `/api/order` заказ можно просмотреть через API после успешного размещения заказа.
4. GET `/api/sku/yueluo-666` можете просматривать баланс запасов после того, как заказ будет сделан через API SKU.

## Сводка.

На данный момент мы завершили "заказ товаров" этот спрос на основной контент.Этот пример дает первоначальное понимание того, как несколько Хлоптрапов могут работать вместе и как Minion может быть использован для выполнения асинхронных задач.

Тем не менее, есть еще некоторые вопросы, которые мы обсудим позже.

Вы можете получить исходный код для этой статьи из следующих：

- [Github.](https://github.com/newbe36524/Newbe.Claptrap.Examples/tree/master/src/Newbe.Claptrap.QuickStart4/HelloClaptrap)
- [Гити.](https://gitee.com/yks/Newbe.Claptrap.Examples/tree/master/src/Newbe.Claptrap.QuickStart4/HelloClaptrap)
