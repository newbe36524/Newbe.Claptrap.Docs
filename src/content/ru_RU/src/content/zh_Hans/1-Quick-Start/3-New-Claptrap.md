---
title: 'Шаг 3 - Определите Claptrap и управляйте инвентаризацией товаров.'
metaTitle: 'Шаг 3 - Определите Claptrap и управляйте инвентаризацией товаров.'
metaDescription: 'Шаг 3 - Определите Claptrap и управляйте инвентаризацией товаров.'
---

С этой статьей, вы можете начать пытаться делать бизнес с Claptrap.

> [Версия в настоящее время рассматривается является результатом китайской упрощенной машины переводит самопроверки и вручную корректирует.Если в документе есть неправильный перевод, пожалуйста, нажмите здесь, чтобы представить свои предложения по переводу.](https://crwd.in/newbeclaptrap)

<!-- more -->

## Резюме открытия.

В этой статье я узнал, как определить Claptrap в существующем образце проекта, реализовав необходимость "управления запасами".

В сочетании с основными этапами предыдущей статьи, определить Claptrap до тех пор, как вы добавляете несколько шагов там.Полные шаги показаны ниже, где раздел с пометкой "Новый контент" отличается от предыдущего нового контента в этом article：

1. Определите ClaptrapTypeCode (Новое содержимое)
1. Определение состояния (новое содержимое)
1. Определите зерновой интерфейс (новое содержимое)
1. Внедрение зерна (новый контент)
1. Подпишитесь на зерно (новый контент)
1. Определите EventCode.
1. Определите событие.
1. Обработчик событий реализации.
1. Подпишитесь на EventHandler.
1. Внедрение IInitial StateDataFactory (новый контент)
1. Модифицировать контроллер.

Это процесс «снизу вверх», и фактический процесс кодирования также может быть скорректирован для разработки.

Случаи использования бизнеса, реализованные в данной статье,：

1. Реализует объект SKU (Stock Keeping Unit), представляющий данные инвентаризации.
2. Возможность обновлять и читать SKUs.

## Определите ClaptrapTypeCode.

ClaptrapTypeCode — это уникальный код для Claptrap.Она играет важную роль в выявлении и сериализации государства.

Открыть`The ClaptrapCodes`класса в`HelloClaptrap.`проекте.

Добавьте ClaptrapTypeCode для SKU.

```cs
  namespace HelloClaptrap.Models

      публичного статического класса ClaptrapCodes

          рекламы и публичности строки Cartin's "cart_claptrap_newbe";
          частной строкой CartEventSuffix , ""e" , "CartGrain";
          публичной рекламы const строки AddItemToCart , "addItem" , "CartEventSuffix";
          публичности конст строки Удалить ItmFromCart , "удалить". eItem" и CartEventSuffix;

          #region Ску

ску СкуГрейн , "sku_claptrap_newbe";
и частная контумЫ SkuEventSuffix, """"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""" ""

          #endregion
      ...
  ...
```

## Определите состояние.

Состояние представляет текущее представление данных объекта Актера в режиме «Актер».

Потому что Claptrap является актером на основе моделей прослеживаемости событий.Поэтому важно точно определить состояние.

В этом примере нам нужно только записать инвентаризацию текущего SKU, так что дизайн государства очень прост.

Добавьте`папку<code>Sku`в проект HelloClaptrap.Models</code>и создайте`папку`SkuState.

Добавить следующий код：

```cs
singningnbe.Claptrap;

и namespace HelloClaptrap.Models.Sku
, s
, общественный класс SkuState : IStateData
,
, общественный int . . .

. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
```

Инвентарь представляет собой инвентаризацию текущего SKU.

`интерфейс`IStateData является пустым интерфейсом в рамках, представляющим состояние и используемым для общего вывода.

## Определите интерфейс Grain.

Определите определение интерфейса Grain, чтобы обеспечить внешнюю совместимость с Claptrap.

Добавьте`интерфейс ISkuGrain``HelloClaptrap.`проект.

Добавьте интерфейсы, а также атрибуты.

```cs
Использование Systems.Threading.Задачи;
петь HelloClaptrap.Модели;
петь HelloClaptrap.Models.Sku;
...
...
,
, namespace HelloClaptrap.IActor
,
, claptrapState , ClaptrapCodes.SkuGrain ,
, общественный интерфейс , . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . ЙКлаптрапрейн
... </summary>

<summary>

... ... <returns></returns>
...         Задача<int> GetInventoryAsync ();

/ / / / <summary>
/ / Обновление инвентаризации по добавить дифф, дифф может быть отрицательным числом
 </summary>
<int> </returns>
<returns><param name="diff"></param>
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
...
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
```

Ниже было added：

1. </code>`ClaptrapState помечено как ассоциированное состояние с зерном.</li>
<li>Интерфейс наследует<code>IClaptrapGrain`, который является рамочным интерфейсом Grain, основанным на интерфейсе, который Орлеан должен унаследовать для запуска.
3. Добавлен метод GetInventoryAsync, который означает "Получить текущий инвентарь".
4. Добавлен метод UpdateInventoryAsync, который означает "постепенное обновление текущего инвентаря".`дифф > 0 указывает на увеличение запасов` ,`дифф < 0`указывает на уменьшение запасов.
5. Важно отметить, что определения метода Grain ограничены.Смотрите[разработка зернового](https://dotnet.github.io/orleans/Documentation/grains/index.html).

## Реализация зерна.

После определения ISkuGrain можно добавить код для реализации.

Создайте`новую<code>папку`Sku для проекта HelloClaptrap.</code>actors и добавьте`папку`SkuGrain.

```cs
+ using System;
+ using System.Threading.Tasks;
+ using HelloClaptrap.IActor;
+ using HelloClaptrap.Models;
+ using HelloClaptrap.Models.Sku;
+ using Newbe.Claptrap;
+ using Newbe.Claptrap.Orleans;
+
+ namespace HelloClaptrap.Actors.Sku
+ {
+     public class SkuGrain : ClaptrapBoxGrain<SkuState>, ISkuGrain
+     {
+         public SkuGrain(IClaptrapGrainCommonService claptrapGrainCommonService)
+             : base(claptrapGrainCommonService)
+         {
+         }
+
+         public Task<int> GetInventoryAsync()
+         {
+             return Task.FromResult(StateData.Inventory);
+         }
+
+         public async Task<int> UpdateInventoryAsync(int diff)
+         {
+             if (diff == 0)
+             {
+                 throw new BizException("diff can`t be 0");
+             }
+
+             var old = StateData.Inventory;
+             var newInventory = old + diff;
+             if (newInventory < 0)
+             {
+                 throw new BizException(
+                     $"failed to update inventory. It will be less than 0 if add diff amount. current : {old} , diff : {diff}");
+             }
+
+             throw new NotImplementedException();
+         }
+     }
+ }
```

Ниже было added：

1. Наследовать`ClaptrapBoxGrain<SkuState>`и реализовать`ISkuGrain`,`ClaptrapBoxGrain`является рамочно-определяемым классом зерновых, где общие параметры представляют соответствующий тип состояния.
2. Реализация метода GetInventoryAsync для чтения текущего кадастра из StateData.
3. Реализуйте метод UpdateInventoryAsync, добавляйте код бизнес-суждения и делайте исключения, если условия для бизнес-операций не соблюдаются.
4. Последний из UpdateInventoryAsync мы бросаем OutImplementEdException, потому что текущее событие еще не определено и нужно ждать последующих реализаций кода.
5. BizException является пользовательским исключением, которое может быть добавлено самостоятельно.В фактической разработке также можно указать прерывание бизнеса, не бросая исключение, а также можно использовать код статуса или другое значение возврата между ними.

## Подпишитесь на зерно.

Зерно, соответствующее Claptrap, должно быть зарегистрировано при запуске приложения, чтобы фреймворк мог сканировать для обнаружения.

Поскольку образец кода использует сканирование в масштабах сборки, никаких изменений на самом деле не требуется.

Вот где регистрация приняла place：

Программа Open`для проекта HelloClap.BackendServer```проекта.

```cs
  Использование системы;
  с помощью Autofac;
  . Хенинг HelloClaptrap.Actors.Cart;
  Соединенные Штаты Китая HelloClaptrap.IActor;
  United Services HelloClaptrap.Repository;
  .AspNetCore.Хостинг;
  .Extensions.Hosting;
  .Extensions.Logging;
  Ньюб.Клэптрап;
  .Клэптрап.Bootstrapper;
  NLog.Web;
  Орлеан;

  пространство имен HelloClaptrap.BackendServer

      программу общественного класса


          публичную статичную IHostBuilder CreateHostBuilder (строка)>
              Host.CreateDefaultBuilder (args)
                  . Настроить webWebHostDaults (веб-застройщик>
                  <Startup>. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . UseClaptrap (
                      строитель>

строитель
. ScanClaptrapDesigns (новый)
,
и typeof (ICartGrain). Сборка,
и Типоф (CartGrain). Собрание,
, s)
                      ,
                      строитель> строитель. RegisterModule<RepositoryModule>(); )
                  . UseOrleansClaptrap ()
                  . UseOrleans (Строители -> Строитель. UseDashboards (варианты> варианты. Порт s 9000))
                  . Настройка (регистрация>

                      журнал. КлирПровидс ();
                      лесозаготовки. SetMinimumLevel (LogLevel.Trace);
                  )
                  . UseNLog ();
      ...
  ...
```

Поскольку ISkuGrain и SkuGrain принадлежат к одной сборке с ICartGrain и CartGrain, соответственно, никаких изменений здесь не требуется.

## Определите EventCode.

Мы реализовали основную часть Claptrap и раньше, но мы еще не завершили операцию обновления запасов.Это связано с тем, что обновление инвентаря требует обновления состояния.И мы все знаем, что Claptrap является событием основе актер шаблон, и обновления в государстве должны быть сделаны через события.Так что начните здесь, давайте обновлять инвентарь через события.

EventCode является единственным кодированием для каждого события в системе Claptrap.Он играет важную роль в выявлении и сериализации событий.

Открыть`The ClaptrapCodes`класса в`HelloClaptrap.`проекте.

Добавить EventCode для инвентаризации обновлений.

```cs
  namespace HelloClaptrap.Models

      публичного статического класса ClaptrapCodes

          #region корзину

          публичной и конст-строки CartGrain s "cart_claptrap_newbe";
          частной строкой CartEventSuffix, ""

          """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""" """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""" Tring RemoveItemFromCart - "RemoveItem" - CartEventSuffix;
          публичная реклама const Строка Удалить AllItems FrommCart , "Remoe AllItems" , CartEventSuffix;

          #endregion

          #region Ску

          публичную рекламу и skuGrain - "sku_claptrap_newbe";
          частной конст-строки SkuEventSuffix . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
skuEvent Suffix, публичность, общественность, и SkuEvent Suffix, "инвентарьUpdate";

          #endregion
      ...
  ...
```

## Определите событие.

Событие является ключом к отслеживанию событий.Используется для изменения состояния в Claptrap.И событие сохраняется на уровне настойчивости.

Создайте`класс<code>Инвентаризация в соответствии с  Sku/Events`папкой`проекте HelloClaptrap.models`</code>.

Добавить следующий код：

```cs
singningnbe.Claptrap;
и
, namespace HelloClap.Models.Sku.Events
,
, общественный класс InventoryUpdateEvent: IEventData



. . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
```

1. Дифф представляет количество запасов для этого обновления,`дифф > 0` указывает на увеличение запасов, а`дифф < 0`указывает на уменьшение запасов.
2. NewInventory представляет обновленный инвентарь.Здесь рекомендация дается заранее, но из-за проблем с продолжительностью, никакое обсуждение：предлагает включить обновленные данные государства в случае.

## Обработчик событий реализации.

`EventHandler`обновить события в системе</code>`Claptrap.</p>

<p spaces-before="0">Создайте<code>класс`инвентаризации  под`Sku/Events`папку для проекта Hello</code>`HelloClaptrap.actors.</p>

<p spaces-before="0">Добавить следующий код：</p>

<pre><code class="cs">Использование Systems.Threading.Задачи;
сей HelloClaptrap.Models.Sku;
поют HelloClaptrap.Models.Sku.Events;
...

и namespace HelloClaptrap.Actors.Sku.Events
,
, общественный класс InventoryUpdateEventHandler
, и : NormalEventHandler<SkuState, InventoryUpdateEvent>
,
, реклама переопределить ValueTask StateData,
, инвентарьUpdateEvent eventData,
, IEventContext eventContext
.
stateData.Inventory , eventData.NewInventory;
и вернуть новую ValueTask ();
...
...
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
`</pre>

1. Поскольку обновленный инвентарь уже включен в событие, можно назначить StateData напрямую.

## Подпишитесь на EventHandler.

После внедрения и тестирования EventHandler вы можете зарегистрировать EventHandler, чтобы связаться с EventCode и Claptrap.

Открыть`SkuGrain`для`HelloClap.`проекта.

Отметьте с атрибутом и измените события выполнения updateInventoryAsync.

```cs
  Использование System.Threading.Задачи;
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
  1990-х годов, HelloClaptrap.IActor;
  Соединенные Штаты Ofsing HelloClaptrap.Models;
  .HelloClaptrap.Models.Sku;
петь HelloClaptrap.Models.Sku.Events;
  .Claptrap;
  Ньюбе.Клэптрап.Орлеан;

  название пространства HelloClaptrap.Actors.Sku


      snr. общественного класса SkuGrain : ClaptrapBoxGrain<SkuState>, ISkuGrain
      ,
          общественный SkuGrain ( IClaptrap Зерно Общие услуги Clap GrainService )
              : База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( База ( claptrapGrainCommonService)
          {
          }

          публичная задача<int> GetInventoryAsync ()

              Return Task.FromResult (StateData.Inventory);
          )

          public Async Task<int> Update InventyAsync (int diff)

              , если

                  бросить новый bizException ("дифф не может быть 0");
              .

              var старый , StateData.Inventory;
              var newInventory , старый , дифф;
              (новаявентия < 0)

                  бросить новый bizException (
                      $"не удалось обновить инвентаризации. Это будет меньше, чем 0, если добавить дифф сумму. текущий : {old} , дифф : {diff}" );
              -

- бросить новый NotImplementedException ();
и var evt , это. СоздатьEvent (новый InventoryUpdateEvent
s
s Diff s diff,
новыйинвенторный с newinventory
s)) ;
и ждут Claptrap.HandleEventAsync (evt);
и вернуть StateData.Inventory;
          ,
      ,
  .
```

## Внедрение IInitial State Data Factory.

Мы уже завершили кадастровый запрос и обновление.Как правило, однако, есть начальная сумма в инвентаре, и мы дополняем эту часть логики в этом разделе.

Создайте`SkuStateInitHandler<code>под  Sku``папку`HelloClaptrap.actors</code>проекта.

```cs
Использование Systems.Threading.Задачи;
сей HelloClaptrap.Models.Sku;
петь HelloClaptrap.Repository;
...
и
, namespace HelloClap.Actors.Sku
,
, общественный класс SkuStateInitHandler : IinitialState DataFactory
,
, частные readonly ISkupositReory _skuRepository;
s
skuStateInitler (
skuReposit
_skuRepository
ory sReposit uRepository;
,
,
, общественный async Task<IStateData> Создать (IClaptrapIdentity Identity)
,
, вар skuId , и личность. Id;
и var инвентаризации _skuRepository.GetInitInventoryAsync (skuId);
и var re , новые SkuState
,
, инвентаризации , инвентаризации
, .
и возвращение повторно;
...
...
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
```

1. `IInitial StateDataFactory`вызван, когда Claptrap впервые активируется для создания начальной стоимости состояния.
2. Инъекция`ISkuRepository`считывает начальную сумму запасов для Sku из базы данных, конкретный код не указан здесь, и читатель может просмотреть реализацию на складе образцов.

В дополнение к коду реализации, регистрация необходима, прежде чем она может быть вызвана.

Открыть`SkuGrain`для`HelloClap.`проекта.

```cs
  Использование System.Threading.Задачи;
  Соединенных Штатах Ofthing Hello Claptrap.Actors.Sku.Events;
  1990-х годов, HelloClaptrap.IActor;
  Соединенные Штаты Ofsing HelloClaptrap.Models;
  .HelloClaptrap.Models.Sku;
  .HelloClaptrap.Models.Sku.Events;
  .Claptrap;
  Ньюбе.Клэптрап.Орлеан;

  Namespace HelloClaptrap.Actors.Sku
  snr.
snr. skptrapState Информационный завод Обработчик)
      snr. (InventoryUpdateEventHandler), ClaptrapCodes.SkuVentory Update)
      общественного класса SkuGrain : ClapBoxGrain<SkuState>, ISkuGrain

          IClaptrapGrainCommonService Claptrap Grain Common Services
              : база (claptrapGrainCommonService)
          {
          }

          публичная задача<int> GetInventoryAsync (

              Return Task.From Reserve (StateData.Inventory);
          ;

          задача общественной информации<int> UpdateInventoryAsync (int diff

              если (дифф s 0)
              s
                  бросить новый bizException ("дифф не может быть 0");
              s

              var старый s StateData.Inventory;
              var newinvent snr . .

                  < 
              . на (
                      $"не удалось обновить инвентарь. Это будет меньше, чем 0, если добавить дифф сумму. текущий : {old} , дифф : {diff}" );
              .

              var evt . . . СоздатьEvent (новый InventoryUpdateEvent

                  Дифф в дифф,
                  NewInventory с новойinventory
              )) ) ;
              .HandleEventAsync (evt);
              StateData.Inventory;
          ,
      ,
  .
```

## Модифицировать контроллер.

После того, как все предыдущие шаги были завершены, все части Claptrap были завершены.Тем не менее, Claptrap не может обеспечить совместимость непосредственно с внешними программами.Поэтому также необходимо добавить API в слой Контроллера для внешних операций "читать инвентарь".

Создайте`новый`SkuController в рамках проекта```HelloClaptrap.`папки контроллеров.

```cs
Использование Systems.Threading.Задачи;
поют HelloClaptrap.IActor;
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
и использование Орлеана;

, namespace HelloClaptrap.Web.Controllers
,
, маршрут (" api /[controller]" ) ,
, общественный класс SkuController : Контроллер
,
, частные readonly IGrain Factory _grainFactory;
s
skuController (
s.iGrainFactory grainfactory)
s.
s. _grainFactory. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . _grainFac

<IActionResult> 
{id}


. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . Тори. GetGrain<ISkuGrain>(id);
s.var инвентаризации skuGrain.GetInventoryAsync ();
, возвращение Json (новый
,
, skuId , id,
, инвентаризации ,
, s) ;
,
,
, ... . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
```

1. Новый API считывает инвентарь для конкретного SkuId.Согласно реализации образца кода, вы можете пройти в`Yueluo-123`вы получите кадастровую сумму 666.SkuId, который не существует, бросает исключение.
1. Здесь нет внешнего API, созданного для обновления инвентаря, потому что этот пример будет выполнять операции инвентаризации при месте покупки заказа в следующей статье, и API не требуется здесь в это время.

## Сводка.

На данный момент мы завершили все содержание простого требования "управление инвентаризации товаров".

Вы можете получить исходный код для этой статьи из следующих：

- [Github.](https://github.com/newbe36524/Newbe.Claptrap.Examples/tree/master/src/Newbe.Claptrap.QuickStart3/HelloClaptrap)
- [Гити.](https://gitee.com/yks/Newbe.Claptrap.Examples/tree/master/src/Newbe.Claptrap.QuickStart3/HelloClaptrap)
